peeringdb-api-key: ${tor01-ca-pop-peeringdb-api-key}
log-file: /var/log/bird.log
global-config: >
  define pop_region = 2;
  define pop_country = 124;
  define pop_id = 10;
  function reject_region_communitys() {
    #if ((202427, 111, 1) ~ bgp_large_community) then reject "Only in Europe";
    if ((202427, 111, 2) ~ bgp_large_community) then reject "Only in North America";
    if ((202427, 112, pop_region) ~ bgp_large_community) then reject "Not in PoP Region";
  }
  function reject_country_communitys() {
    #if ((202427, 113, 124) ~ bgp_large_community) then reject "Only in Canada";
    if ((202427, 113, 276) ~ bgp_large_community) then reject "Only in Germany";
    if ((202427, 113, 380) ~ bgp_large_community) then reject "Only in Italy";
    if ((202427, 113, 528) ~ bgp_large_community) then reject "Only in Netherlands";
    if ((202427, 113, 578) ~ bgp_large_community) then reject "Only in Norway";
    if ((202427, 113, 756) ~ bgp_large_community) then reject "Only in Switzerland";
    if ((202427, 113, 840) ~ bgp_large_community) then reject "Only in United States of America";
    if ((202427, 114, pop_country) ~ bgp_large_community) then reject "Not in PoP Country";
  }
  function reject_pop_communitys() {
    if ((202427, 115, 1) ~ bgp_large_community) then reject "Only at rma01.ch";
    if ((202427, 115, 2) ~ bgp_large_community) then reject "Only at fra01.de";
    if ((202427, 115, 3) ~ bgp_large_community) then reject "Only at Reserved";
    if ((202427, 115, 4) ~ bgp_large_community) then reject "Only at zhr02.ch";
    if ((202427, 115, 5) ~ bgp_large_community) then reject "Only at mil01.it";
    if ((202427, 115, 6) ~ bgp_large_community) then reject "Only at dus01.de";
    if ((202427, 115, 7) ~ bgp_large_community) then reject "Only at ams01.nl";
    if ((202427, 115, 8) ~ bgp_large_community) then reject "Only at Reserved";
    if ((202427, 115, 9) ~ bgp_large_community) then reject "Only at van01.ca";
    #if ((202427, 115, 10) ~ bgp_large_community) then reject "Only at tor01.ca";
    if ((202427, 115, 11) ~ bgp_large_community) then reject "Only at fmt01.us";
    if ((202427, 115, 12) ~ bgp_large_community) then reject "Only at Reserved";
    if ((202427, 115, 13) ~ bgp_large_community) then reject "Only at Reserved";
    if ((202427, 115, 14) ~ bgp_large_community) then reject "Only at Reserved";
    if ((202427, 115, 15) ~ bgp_large_community) then reject "Only at Reserved";
    if ((202427, 116, pop_id) ~ bgp_large_community) then reject "Not at PoP";
  }
  function reject_out_of_region() {
    if ! ((202427, 103, pop_region) ~ bgp_large_community) then reject "Out of Region PoP";
  }
local-communities:
  - "202427:101:1"
  - "202427:106:10" # PoP
add-on-import:
  - "202427:102:124" # Country
  - "202427:103:2" # Region
  - "202427:104:10" # PoP
add-on-export:
  - "202427:105:10" # PoP
asn: 202427
prefixes: # Location Specific
  - 2a06:a005:28e0::/48 # AS202427-BACKBONE-NETWORK
  - 2a06:a005:28ea::/48 # AS202427-BACKBONE-NETWORK
  - 2a0a:6040:27a0::/43 # CA-AS202427
  - 2a0a:6040:27e0::/43 # EU-AS202427
 #- 2a07:54c2:b00b::/48 # ::/b00b collective
router-id: 104.167.228.27 # PoP
irr-server: 128.241.192.40 # rr.ntt.net
source6: 2a06:a005:28ea::1 # PoP
default-route: false
blackhole-bogon-asns: true

peers:
  # ========= Upstreams =========
  Xenyth:
    template: upstream
    description: Xenyth Cloud Upstream
    asn: 835
    neighbors:
      - 2602:fd50:100::5
    local-pref: 120
    multihop: true
    listen6: 2602:fd50:0100:006d:5dac:5bd6:bc85:e12e
    as-set: ARIN::AS-GOCODEIT-ALL

  Hurricane Electric ONIX:
    template: upstream
    description: Hurricane Electric LLC Upstream via ONIX
    asn: 6939
    neighbors:
      - 2001:504:125:e1::3
    local-pref: 130
    listen6: 2001:504:125:e1::c
    add-on-import:
      - "202427:108:4059"
    as-set: RADB::AS-HURRICANEV6

  # ========= Looking Glasses =========
  pmacctd:
    template: lg
    description: pmacctd
    asn: 202427
    listen6: 127.0.0.1
    neighbors:
      - 127.0.0.2
    neighbor-port: 180
    mp-unicast-46: true

  qrator:
    template: lg
    description: Radar by Qrator
    asn: 197068
    neighbors:
      - 178.248.237.29
    multihop: true
    listen4: 104.167.228.27

  bgpTools:
    template: lg
    description: BGP.Tools Route Collector
    asn: 212232
    neighbors:
      - 185.230.223.56
    multihop: true
    listen4: 104.167.228.27

  # ========= Route Servers =========
  ONIX Route Server:
    template: routeserver
    description: ONIX Route Server
    asn: 57369
    neighbors:
      - 2001:504:125:e1::1
      - 2001:504:125:e1::2
    local-pref: 220
    listen6: 2001:504:125:e1::c
    add-on-import:
      - "202427:108:4059" # IX
    as-set: AS57369:AS-ONIX

  # ========= Peers - ONIX =========
  AS112 ONIX:
    template: peer
    description: AS112 via ONIX
    asn: 112
    neighbors:
      - 2001:504:125:e1::112
    local-pref: 320
    listen6: 2001:504:125:e1::c
    add-on-import:
      - "202427:108:4059" # IX
    as-set: AS112

  KTT Iceland ONIX:
    template: peer
    description: KTT Iceland via ONIX
    asn: 51019
    neighbors:
      - 2001:504:125:e1::17
    local-pref: 320
    listen6: 2001:504:125:e1::c
    add-on-import:
      - "202427:108:4059" # IX
    as-set: AS51019:AS-ALL

  Linode ONIX:
    template: peer
    description: Linode via ONIX
    asn: 63949
    neighbors:
      - 2001:504:125:e1::31
    local-pref: 320
    listen6: 2001:504:125:e1::c
    add-on-import:
      - "202427:108:4059" # IX
    as-set: AS-LINODE

  MythicalKitten ONIX:
    template: peer
    description: MythicalKitten via ONIX
    asn: 48581
    neighbors:
      - 2001:504:125:e1::16
    local-pref: 320
    listen6: 2001:504:125:e1::c
    add-on-import:
      - "202427:108:4059" # IX
    as-set: RIPE::AS-MYTHICALKITTEN

  Thomas Riley Brown ONIX:
    template: peer
    passive: true
    description: Thomas Riley Brown via ONIX
    asn: 203069
    neighbors:
      - 2001:504:125:e1::ad
    local-pref: 320
    listen6: 2001:504:125:e1::c
    add-on-import:
      - "202427:108:4059" # IX
    as-set: AS-XZR

  AS212635 ONIX:
    template: peer
    passive: true
    description: AS212635 via ONIX
    asn: 212635
    neighbors:
      - 2001:504:125:e1::67
    local-pref: 320
    listen6: 2001:504:125:e1::c
    add-on-import:
      - "202427:108:4059" # IX
    as-set: RIPE::AS212635:AS-212635

# ===========================================================

templates:
  upstream:
    local-pref: 100
    add-path-tx: true
    add-path-rx: true
    pre-import-accept: >
     bgp_large_community.add((202427,101,2));
     bgp_large_community.add((202427,107,<pathvector.asn>));
    pre-export: >
     reject_region_communitys();
     reject_country_communitys();
     if ((202427, 110, <pathvector.asn>) ~ bgp_large_community) then reject;
    announce:
      - "202427:101:1"
      - "202427:101:5"
    remove-all-communities: 202427
    allow-blackhole-community: true
    filter-max-prefix: false
    role: customer

  routeserver:
    local-pref: 200
    add-path-tx: true
    add-path-rx: true
    pre-import-accept: >
     bgp_large_community.add((202427,101,3));
     bgp_large_community.add((202427,107,<pathvector.asn>));
    pre-export: >
     reject_region_communitys();
     reject_country_communitys();
     if ((202427, 110, <pathvector.asn>) ~ bgp_large_community) then reject;
    announce:
      - "202427:101:1"
      - "202427:101:5"
    remove-all-communities: 202427
    allow-blackhole-community: true
    enforce-first-as: false
    enforce-peer-nexthop: false
    filter-max-prefix: false
    filter-transit-asns: true
#    filter-never-via-route-servers: true

  peer:
    local-pref: 300
    add-path-tx: true
    add-path-rx: true
    pre-import-accept: >
     bgp_large_community.add((202427,101,4));
     bgp_large_community.add((202427,107,<pathvector.asn>));
    pre-export: >
     reject_region_communitys();
     reject_country_communitys();
     if ((202427, 110, <pathvector.asn>) ~ bgp_large_community) then reject;
    announce:
      - "202427:101:1"
      - "202427:101:5"
    remove-all-communities: 202427
    allow-blackhole-community: true
    filter-irr: true
    strict-rpki: true
    filter-transit-asns: true
    auto-import-limits: true
    role: peer

  downstream:
    local-pref: 400
    add-path-tx: true
    add-path-rx: true
    pre-import-accept: >
     bgp_large_community.add((202427,101,5));
     bgp_large_community.add((202427,107,<pathvector.asn>));
    pre-export: >
     reject_region_communitys();
     reject_country_communitys();
     if ((202427, 110, <pathvector.asn>) ~ bgp_large_community) then reject;
    announce:
      - "202427:101:1"
      - "202427:101:2"
      - "202427:101:3"
      - "202427:101:4"
      - "202427:101:5"
    remove-all-communities: 202427
    allow-blackhole-community: true
    filter-irr: true
    strict-rpki: true
    filter-transit-asns: true
    auto-import-limits: true
    role: provider

  lg:
    mp-unicast-46: true
    add-path-tx: true
    announce:
      - "202427:101:1"
      - "202427:101:2"
      - "202427:101:3"
      - "202427:101:4"
      - "202427:101:5"
    receive-limit4: 0
    receive-limit6: 0

  core-wg:
    prepends: 1
    local-pref: 180
    next-hop-self: true
    allow-local-as: true
    add-path-tx: true
    add-path-rx: true
    announce:
      - "202427:101:3"
      - "202427:101:4"
      - "202427:101:5"
    remove-communities:
      - "202427:105:1"
      - "202427:105:2"
      - "202427:105:3"
      - "202427:105:4"
      - "202427:105:5"
      - "202427:105:6"
      - "202427:105:7"
      - "202427:105:8"
      - "202427:105:9"
      - "202427:105:10"
      - "202427:105:11"
      - "202427:105:12"
      - "202427:105:13"
      - "202427:105:14"
      - "202427:105:15"
    allow-blackhole-community: true

  core-l2:
    local-pref: 190
    next-hop-self: true
    allow-local-as: true
    add-path-tx: true
    add-path-rx: true
    announce:
      - "202427:101:3"
      - "202427:101:4"
      - "202427:101:5"
    remove-communities:
      - "202427:105:1"
      - "202427:105:2"
      - "202427:105:3"
      - "202427:105:4"
      - "202427:105:5"
      - "202427:105:6"
      - "202427:105:7"
      - "202427:105:8"
      - "202427:105:9"
      - "202427:105:10"
      - "202427:105:11"
      - "202427:105:12"
      - "202427:105:13"
      - "202427:105:14"
      - "202427:105:15"
    enforce-first-as: false
    allow-blackhole-community: true
    filter-rpki: false
